# Flowâ‘  Implementation Complete! ğŸ‰

This PR implements a complete cloud-based hands-on workshop for Azure AI Foundry Agent with MCP (Model Context Protocol) and user-based filtering.

## ğŸ“¦ What's Included

### Infrastructure (Bicep)
- âœ… Azure API Management (BasicV2) with JWT validation
- âœ… Azure Function App (Python 3.11) - MCP Server
- âœ… Azure Web App (Node.js 20) - Next.js UI
- âœ… Application Insights + Log Analytics

### MCP Server (Python)
- âœ… `get_weather` tool with user-specific responses
- âœ… Celsius for even user ID hash, Fahrenheit for odd
- âœ… Reads `X-EndUser-Id` header set by APIM

### Web App (Next.js + TypeScript)
- âœ… MSAL authentication with Azure AD
- âœ… Chat UI with real-time responses
- âœ… `/api/chat` endpoint that calls Foundry Agent
- âœ… Bearer token propagation to APIM

### Deployment Automation
- âœ… `deploy-infra.sh` - Complete Bicep deployment
- âœ… `deploy-function.sh` - Function deployment + APIM config
- âœ… `deploy-webapp.sh` - Web App build and deployment
- âœ… `create_agent.py` - Foundry Agent setup

### Documentation
- âœ… Complete README with step-by-step instructions
- âœ… Quick Start Guide (5 minutes to try locally)
- âœ… Architecture Diagrams (text-based)
- âœ… Testing Guide with curl examples
- âœ… Implementation Guide with detailed explanations
- âœ… Acceptance Checklist
- âœ… Contributing Guide

### Testing
- âœ… Local integration test script
- âœ… Curl examples for all scenarios
- âœ… User-specific response validation

## ğŸ¯ Key Features

1. **JWT Validation at APIM**
   - Validates Azure AD tokens
   - Extracts `oid` (user object ID)
   - Prevents client-side header spoofing

2. **User-Specific Responses**
   - Based on user ID hash
   - Even hash â†’ Celsius (Â°C)
   - Odd hash â†’ Fahrenheit (Â°F)

3. **Complete Security**
   - HTTPS everywhere
   - Function keys protected
   - JWT signature verification
   - Proper CORS configuration

## ğŸš€ Quick Start

```bash
# 1. Deploy infrastructure (20-30 min)
./scripts/deploy-infra.sh

# 2. Deploy Function (2-3 min)
./scripts/deploy-function.sh

# 3. Create Foundry Agent (1-2 min)
python scripts/create_agent.py --project-endpoint <endpoint> --project-key <key> --apim-endpoint $(jq -r '.apimMcpEndpoint' deployment-outputs.json)

# 4. Deploy Web App (5-10 min)
./scripts/deploy-webapp.sh
```

## ğŸ“ File Structure

```
foundry-agent-mcp-handson/
â”œâ”€â”€ infra/                      # Bicep templates
â”‚   â”œâ”€â”€ main.bicep
â”‚   â”œâ”€â”€ resources.bicep
â”‚   â””â”€â”€ parameters.json
â”œâ”€â”€ mcp-server/                 # Azure Functions (Python)
â”‚   â”œâ”€â”€ function_app.py
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ host.json
â”œâ”€â”€ webapp/                     # Next.js Web App
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ page.tsx           # Chat UI
â”‚   â”‚   â”œâ”€â”€ api/chat/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts       # Foundry Agent API
â”‚   â”‚   â””â”€â”€ MsalProvider.tsx   # MSAL Auth
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ authConfig.ts
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ scripts/                    # Deployment & testing
â”‚   â”œâ”€â”€ deploy-infra.sh
â”‚   â”œâ”€â”€ deploy-function.sh
â”‚   â”œâ”€â”€ deploy-webapp.sh
â”‚   â”œâ”€â”€ create_agent.py
â”‚   â””â”€â”€ test-local.sh
â””â”€â”€ docs/                       # Documentation
    â”œâ”€â”€ QUICKSTART.md
    â”œâ”€â”€ ARCHITECTURE.md
    â”œâ”€â”€ TESTING.md
    â””â”€â”€ ACCEPTANCE_CHECKLIST.md
```

## âœ… Acceptance Criteria Met

- [x] Tokenç„¡ã—ã§APIMã¯401ã‚’è¿”ã™
- [x] Tokenæœ‰ã‚Šã§MCP toolãŒå‹•ä½œ
- [x] ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§çµæœãŒå¤‰ã‚ã‚‹
- [x] READMEã«å®Œå…¨ãªãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

## ğŸ§ª Testing

```bash
# Local testing
cd mcp-server && func start
./scripts/test-local.sh

# Azure testing
curl -X POST $(jq -r '.apimMcpEndpoint' deployment-outputs.json)
# Expected: 401 Unauthorized

# With token
TOKEN=$(az account get-access-token --resource "api://$(jq -r '.clientId' deployment-outputs.json)" --query accessToken -o tsv)
curl -X POST $(jq -r '.apimMcpEndpoint' deployment-outputs.json) \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"method":"tools/list","id":"1"}'
# Expected: Tool list
```

## ğŸ“š Documentation

See comprehensive documentation in:
- `README.md` - Main documentation (Japanese)
- `docs/QUICKSTART.md` - 5-minute quick start
- `docs/ARCHITECTURE.md` - Detailed architecture
- `docs/TESTING.md` - Testing procedures
- `IMPLEMENTATION_SUMMARY.md` - Complete overview

Ready for deployment! ğŸš€
